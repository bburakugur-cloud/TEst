<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GÃ¶rev ZamanlayÄ±cÄ± v2.41 â€” Stabil</title>
<style>
:root { --bg:#0b0c10; --card:#121318; --text:#f5f7fb; --muted:#aab3c5; --accent:#4f8cff; --danger:#ff5c5c; --ok:#22c55e; --line:#2b2f3a; --warn:#fbbf24;}
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
body{margin:0;background:var(--bg);color:var(--text)}
.container{max-width:1100px;margin:0 auto;padding:16px}
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab{flex:1;text-align:center;padding:12px;border-radius:12px;background:#1a1c24;color:var(--muted);cursor:pointer;border:1px solid #222}
.tab.active{background:var(--card);color:var(--text);border-color:var(--line)}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
.row{display:flex;gap:8px;align-items:center}
input[type=text],input[type=number],textarea,select{flex:1;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1015;color:var(--text)}
textarea{min-height:64px;resize:vertical}
button{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#1a1c24;color:var(--text);cursor:pointer}
button.primary{background:var(--accent);border-color:#2a6fe6;color:#fff}
button.danger{background:var(--danger);border-color:#b03434;color:#fff}
.list{list-style:none;margin:0;padding:0}
.item{padding:10px;border:1px solid var(--line);border-radius:10px;margin-top:8px;background:#12141b}
.item-header{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
.badge{font-size:12px;color:#fff;background:#2b2f3a;padding:4px 8px;border-radius:999px}
.hint{color:var(--muted);font-size:13px;margin-top:8px}
.pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #2b2f3a;background:#0f1015}
.switch{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#151824}
.ring{width:120px;height:120px;margin:6px auto;border-radius:999px;background:conic-gradient(var(--accent) 0deg, #2b2f3a 0deg);display:flex;align-items:center;justify-content:center}
.ring span{font-size:28px;font-weight:700}
.bar{height:14px;background:#0f1015;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.fill{height:100%;background:linear-gradient(90deg,var(--accent),#7aa7ff)}
dialog{border:none;border-radius:16px;padding:0;max-width:920px;width:96%}
.modal{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:22px}
.kv-stem{font-size:26px;line-height:1.25;text-align:center;margin:10px 0 6px}
.kv-media{display:flex;flex-direction:column;align-items:center;gap:6px;margin:8px auto}
.kv-img{max-width:640px;max-height:320px;border-radius:12px;border:1px solid var(--line);display:none}
.kv-audio{width:100%;max-width:640px;display:none}
.kv-opts{display:grid;grid-template-columns:1fr 1fr;gap:8px;max-width:720px;margin:0 auto}
.kv-opts button{justify-content:flex-start;gap:8px;display:flex;align-items:center}
.opt-correct{outline:2px solid var(--ok)}
.opt-wrong{outline:2px solid var(--danger)}
.wheel-result{margin-top:10px;border-top:1px dashed var(--line);padding-top:16px;display:none;text-align:center}
.countdown{height:10px;background:#0f1015;border:1px solid var(--line);border-radius:999px;overflow:hidden;max-width:360px;margin:8px auto 0}
.countdown > div{height:100%;width:100%;background:linear-gradient(90deg,var(--warn), #f59e0b)}
.small{font-size:12px;color:var(--muted)}
.task-grid{display:grid;grid-template-columns:1.2fr 0.6fr 0.6fr 1fr;gap:8px}
.task-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
.task-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.task-row{border:1px dashed var(--line);border-radius:10px;padding:10px;margin-top:8px}
.task-title{font-weight:700}
.task-meta{color:var(--muted);font-size:13px}
.reward-meta{margin-top:8px;text-align:center}
.reward-meta .line{margin:2px 0}

/* --- injected: numbering + drag handle for task rows (non-breaking) --- */
.task-num{width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;
  border-radius:8px;background:#1a1c24;border:1px solid var(--line);font-weight:700;margin-right:8px}
.task-row{position:relative}
.task-row .drag-handle{cursor:grab;user-select:none;margin-right:8px}
.task-row.dragging{opacity:.6;outline:2px dashed var(--accent)}


/* --- injected: iki oyuncu skor tablosu (D/Y) --- */
.kv-board{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0 0 0}
.kv-card{background:#121318;border:1px solid var(--line);border-radius:12px;padding:10px}
.kv-board h4{margin:0 0 6px 0;font-size:14px;color:#cdd3e0}
.kv-table{width:100%;border-collapse:separate;border-spacing:0 6px;font-size:14px}
.kv-table td{padding:6px 10px;background:#0f1015;border:1px solid var(--line)}
.kv-table td:first-child{border-radius:8px 0 0 8px}
.kv-table td:last-child{border-radius:0 8px 8px 0;text-align:right}
.kv-pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2b2f3a;background:#0f1015;font-size:12px;color:#aab3c5}
.kv-log{max-height:160px;overflow:auto;border-top:1px dashed var(--line);margin-top:8px;padding-top:6px;font-size:12px;color:#aab3c5}
.kv-ok{color:#22c55e}
.kv-no{color:#ff6b6b}

</style>
</head>
<body>
<div class="container">
  <div class="tabs">
    <div id="tabSettings" class="tab active">Ayarlar</div>
    <div id="tabRun" class="tab">BaÅŸlat</div>
  </div>

  <div id="viewSettings" class="card">
    <div class="row" style="justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px">
      <h2 style="margin:0">Kategoriler ve GÃ¶revler</h2>
      <div class="row" style="gap:6px;flex-wrap:wrap">
        <button id="btnExportHtml" class="primary">ğŸ’¾ Yedekli HTML indir</button>
        <button id="btnExportJson">ğŸ“¦ Verileri DÄ±ÅŸa Aktar (JSON)</button>
        <button id="btnImportFile">ğŸ“¥ Dosyadan YÃ¼kle (JSON/HTML)</button>
        <input id="importInput" type="file" accept=".html,.htm,.json" style="display:none">
        <button id="btnRoundRobin" class="switch">Her Kategoriden 1 GÃ¶rev (RR): KapalÄ±</button>
        <button id="btnShuffleCats" class="switch">Kategori SÄ±rasÄ±: Sabit</button>
        <button id="btnSeq" class="switch">SÄ±ralÄ± Ä°lerleme: AÃ§Ä±k</button>
        <button id="btnResetDone" class="danger">TamamlananlarÄ± SÄ±fÄ±rla</button>
      </div>
    </div>

    <div class="row" style="flex-wrap:wrap">
      <input id="catInput" type="text" placeholder="Yeni kategori adÄ±..." />
      <button class="primary" id="btnAddCat">+ Kategori Ekle</button>
    </div>
    <p class="hint">Her kategoride <b>GÃ¶rev Pozisyonu</b> ve <b>GÃ¶rev TalimatÄ±</b> alanlarÄ± var. <b>Kategori iÃ§i gÃ¶rev sÄ±ralamasÄ±</b> Sabit/KarÄ±ÅŸÄ±k olarak seÃ§ilebilir.</p>
    <ul id="catList" class="list"></ul>
  </div>

  <div id="viewRun" class="card" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Genel KÃ¼ltÃ¼r â€” 300 Soru (GÃ¶rsel + Sesli + MantÄ±k)</h2>
      <button id="btnNewGame" class="danger">ğŸ” Yeni Oyun</button>
    </div>
    <p class="hint">DoÄŸru +10 / YanlÄ±ÅŸ -5 â†’ GÃ¶rev aÃ§Ä±lÄ±yor... â€” 30 puanda Åans Ã‡arkÄ± â†’ 5 sn â€œGÃ¶rev aÃ§Ä±lÄ±yorâ€¦â€ â†’ GÃ¶rev ekranÄ± (sÄ±ralÄ± kategori).</p>
<div class="kv-board">
  <div class="kv-card">
    <h4>Skor Ã‡izelgesi (Toplam)</h4>
    <table class="kv-table">
      <tr><td>KadÄ±n â€” DoÄŸru</td><td><span id="kvKDogru" class="kv-pill">0</span></td></tr>
      <tr><td>KadÄ±n â€” YanlÄ±ÅŸ</td><td><span id="kvKYanlis" class="kv-pill">0</span></td></tr>
      <tr><td>Erkek â€” DoÄŸru</td><td><span id="kvEDogru" class="kv-pill">0</span></td></tr>
      <tr><td>Erkek â€” YanlÄ±ÅŸ</td><td><span id="kvEYanlis" class="kv-pill">0</span></td></tr>
    </table>
  </div>
  <div class="kv-card">
    <h4>Soru GeÃ§miÅŸi</h4>
    <div id="kvLog" class="kv-log"></div>
  </div>
</div>


    <div class="row" style="gap:12px;flex-wrap:wrap">
      <div class="card" style="flex:1;min-width:260px">
        <div class="row" style="justify-content:space-between"><span class="pill">KadÄ±n</span> <span id="kvKWheel" class="kv-pill">Ã‡ark: 0/30</span><b id="kScoreLbl">0 / 30</b></div>
        <div class="bar" style="margin-top:6px"><div id="kFill" class="fill" style="width:0%"></div></div>
      </div>
      <div class="card" style="flex:1;min-width:260px">
        <div class="row" style="justify-content:space-between"><span class="pill">Erkek</span> <span id="kvEWheel" class="kv-pill">Ã‡ark: 0/30</span><b id="eScoreLbl">0 / 30</b></div>
        <div class="bar" style="margin-top:6px"><div id="eFill" class="fill" style="width:0%"></div></div>
      </div>
    </div>

    <div class="row" style="justify-content:center;gap:8px;margin-top:8px">
      <span class="pill">SÄ±ra: <b id="kvTurnLbl">KadÄ±n</b></span>
      <button id="kvSwap">SÄ±rayÄ± DeÄŸiÅŸtir</button>
      <button id="kvNew" class="primary">Yeni Soru</button>
    </div>

    <div class="ring"><span id="kvTimer">30</span></div>
    <div id="kvStem" class="kv-stem">HazÄ±r olduÄŸunuzda â€œYeni Soruâ€ya basÄ±n.</div>

    <div class="kv-media">
      <img id="kvImg" class="kv-img" alt="soru gÃ¶rseli">
      <audio id="kvAudio" class="kv-audio" controls preload="auto"></audio>
    </div>

    <div class="kv-opts">
      <button id="opt0"><span class="kv-letter">A</span><span class="txt"></span></button>
      <button id="opt1"><span class="kv-letter">B</span><span class="txt"></span></button>
      <button id="opt2"><span class="kv-letter">C</span><span class="txt"></span></button>
      <button id="opt3"><span class="kv-letter">D</span><span class="txt"></span></button>
    </div>
  </div>
</div>

<div id="toast" style="position:fixed;top:16px;right:16px;display:none;z-index:9999">
  <div style="background:#1a1c24;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.4);display:flex;align-items:center;gap:8px">
    <div style="width:8px;height:8px;border-radius:50%;background:var(--warn);box-shadow:0 0 0 4px rgba(251,191,36,.15)"></div>
    <div id="toastMsg">YÃ¼kleme</div>
  </div>
</div>

<dialog id="rewardDlg">
  <div class="modal">
    <div class="row" style="justify-content:space-between"><h3 style="margin:0">ğŸ‰ Ã–zel GÃ¶rev</h3><span class="badge" id="rewardWho">â€”</span></div>
    <div class="ring" style="width:160px;height:160px"><span id="rewardTimer">30</span></div>
    <img id="rewardImg" class="kv-img" style="display:none;max-width:240px;max-height:180px" alt="gÃ¶rev gÃ¶rseli" />
    <div class="reward-meta">
      <div class="line task-title" id="rewardTitle">â€”</div>
      <div class="line task-meta" id="rewardPos">Pozisyon: â€”</div>
      <div class="line task-meta" id="rewardInst">Talimat: â€”</div>
    </div>
    <div class="row" style="justify-content:center;gap:8px;margin-top:8px">
      <button id="rewardStart" class="primary">BaÅŸlat</button>
      <button id="rewardDone">TamamlandÄ±</button>
      <button id="rewardSkip" class="danger">Pas</button>
    </div>
  </div>
</dialog>

<dialog id="wheelDlg">
  <div class="modal">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">ğŸ¯ Åans Ã‡arkÄ±</h3>
      <span class="hint">SÄ±ralÄ± mod: Ä°lk tamamlanmamÄ±ÅŸ kategoriden gÃ¶rev aÃ§Ä±lÄ±r. KarÄ±ÅŸÄ±k/Sabit sÄ±rasÄ± uygulanÄ±r.</span>
    </div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:10px">
      <canvas id="wheelCanvas" width="380" height="380" style="border-radius:50%;border:1px solid var(--line);background:#0f1015"></canvas>
      <div class="row" style="gap:8px">
        <button id="wheelSpin" class="primary">â–¶ Ã‡evir</button>
        <button id="wheelCancel">Ä°ptal</button>
      </div>
      <div id="wheelResult" class="wheel-result">
        <div class="big" id="wheelMsg">GÃ¶rev aÃ§Ä±lÄ±yorâ€¦</div>
        <div class="countdown" style="margin-top:8px"><div id="wheelCdFill"></div></div>
        <div class="hint" id="wheelCdLabel" style="text-align:center;margin-top:4px">5 sn</div>
        <div class="row" style="justify-content:center;gap:8px;margin-top:8px">
          <button id="wheelStop" class="danger">Ä°ptal</button>
        </div>
      </div>
    </div>
  </div>
</dialog>

<audio id="beep" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
const QUESTION_BANK = {"count":29,"items":[{"type":"mcq","stem":"DÃ¼nyanÄ±n en bÃ¼yÃ¼k okyanusu hangisidir?","options":["Hint Okyanusu","Atlas Okyanusu","BÃ¼yÃ¼k Okyanus","Arktik Okyanusu"],"answer":"BÃ¼yÃ¼k Okyanus"},{"type":"mcq","stem":"TÃ¼rkiye Cumhuriyeti hangi yÄ±lda ilan edildi?","options":["1920","1921","1922","1923"],"answer":"1923"},{"type":"mcq","stem":"Kimyada 'Na' sembolÃ¼ hangi elementi ifade eder?","options":["Azot","Sodyum","Magnezyum","Nikel"],"answer":"Sodyum"},{"type":"mcq","stem":"WHO (DÃ¼nya SaÄŸlÄ±k Ã–rgÃ¼tÃ¼) merkezi nerededir?","options":["Washington","Londra","Cenevre","Paris"],"answer":"Cenevre"},{"type":"mcq","stem":"Ay'Ä±n DÃ¼nya etrafÄ±ndaki yÃ¶rÃ¼nge sÃ¼resi yaklaÅŸÄ±k kaÃ§ gÃ¼ndÃ¼r?","options":["24","30","27","29"],"answer":"27"},{"type":"mcq","stem":"IÅŸÄ±k yÄ±lÄ± hangi bÃ¼yÃ¼klÃ¼ÄŸÃ¼n Ã¶lÃ§Ã¼sÃ¼dÃ¼r?","options":["Zaman","KÃ¼tle","Mesafe","SÄ±caklÄ±k"],"answer":"Mesafe"},{"type":"mcq","stem":"DNA'nÄ±n yapÄ±taÅŸÄ± olan bazlardan biri deÄŸildir:","options":["Adenin","Timin","Guanin","Riboz"],"answer":"Riboz"},{"type":"mcq","stem":"Mona Lisa tablosunun ressamÄ± kimdir?","options":["Michelangelo","Leonardo da Vinci","Raphael","Van Gogh"],"answer":"Leonardo da Vinci"},{"type":"mcq","stem":"OsmanlÄ± Devleti'nin kurucusu kimdir?","options":["Osman Bey","Orhan Gazi","YÄ±ldÄ±rÄ±m Bayezid","Fatih Sultan Mehmet"],"answer":"Osman Bey"},{"type":"mcq","stem":"H2O formÃ¼lÃ¼ hangi maddeyi ifade eder?","options":["Hidrojen peroksit","Su","Amonyak","Metan"],"answer":"Su"},{"type":"mcq","stem":"Fransa'nÄ±n baÅŸkenti neresidir?","options":["Berlin","Madrid","Paris","Roma"],"answer":"Paris"},{"type":"mcq","stem":"Newton'un hareket yasalarÄ± kaÃ§ tanedir?","options":["1","2","3","4"],"answer":"3"},{"type":"mcq","stem":"'Sefiller' romanÄ±nÄ±n yazarÄ± kimdir?","options":["Victor Hugo","Balzac","Tolstoy","Dostoyevski"],"answer":"Victor Hugo"},{"type":"mcq","stem":"TÃ¼rkiye'nin en uzun nehri hangisidir?","options":["KÄ±zÄ±lÄ±rmak","FÄ±rat","Dicle","Sakarya"],"answer":"KÄ±zÄ±lÄ±rmak"},{"type":"mcq","stem":"Ä°nsan vÃ¼cudunda oksijeni taÅŸÄ±yan protein hangisidir?","options":["Miyoglobin","Hemoglobin","Albumin","Keratin"],"answer":"Hemoglobin"},{"type":"mcq","stem":"AltÄ±nÄ±n kimyasal sembolÃ¼ nedir?","options":["Ag","Au","Al","Pt"],"answer":"Au"},{"type":"mcq","stem":"DÃ¼nya'ya en yakÄ±n yÄ±ldÄ±z (GÃ¼neÅŸ hariÃ§) hangisidir?","options":["Betelgeuse","Sirius","Proxima Centauri","Vega"],"answer":"Proxima Centauri"},{"type":"mcq","stem":"Ä°stanbul hangi iki kÄ±tayÄ± birleÅŸtirir?","options":["Asya ve Avrupa","Avrupa ve Afrika","Asya ve Afrika","Kuzey Amerika ve Avrupa"],"answer":"Asya ve Avrupa"},{"type":"mcq","stem":"Einstein'Ä±n Ã¼nlÃ¼ denklemi hangisidir?","options":["F=ma","E=mc^2","pV=nRT","a^2+b^2=c^2"],"answer":"E=mc^2"},{"type":"mcq","stem":"OsmanlÄ±'da 'Tanzimat FermanÄ±' hangi yÄ±lda ilan edildi?","options":["1826","1839","1856","1876"],"answer":"1839"},{"type":"mcq","stem":"Fotosentez iÃ§in gerekli gaz hangisidir?","options":["Oksijen","Azot","Karbondioksit","Helyum"],"answer":"Karbondioksit"},{"type":"mcq","stem":"Ekvator hangi enlem derecesidir?","options":["0Â°","23.5Â°","45Â°","66.5Â°"],"answer":"0Â°"},{"type":"mcq","stem":"'YÃ¼zÃ¼klerin Efendisi' Ã¼Ã§lemesinin yazarÄ± kimdir?","options":["J.K. Rowling","J.R.R. Tolkien","C.S. Lewis","George R.R. Martin"],"answer":"J.R.R. Tolkien"},{"type":"mcq","stem":"DÃ¼nyanÄ±n en yÃ¼ksek daÄŸÄ± hangisidir?","options":["K2","Everest","Kangchenjunga","Lhotse"],"answer":"Everest"},{"type":"mcq","stem":"Elektrik akÄ±mÄ±nÄ±n birimi nedir?","options":["Volt","Ohm","Amper","Watt"],"answer":"Amper"},{"type":"mcq","stem":"TÃ¼rkiye'nin milli marÅŸÄ±nÄ±n adÄ± nedir?","options":["GenÃ§lik MarÅŸÄ±","Ä°stiklal MarÅŸÄ±","Onuncu YÄ±l MarÅŸÄ±","Zafer MarÅŸÄ±"],"answer":"Ä°stiklal MarÅŸÄ±"},{"type":"mcq","stem":"Atom numarasÄ± 1 olan element hangisidir?","options":["Helyum","Hidrojen","Lityum","Karbon"],"answer":"Hidrojen"},{"type":"mcq","stem":"'KaplumbaÄŸa Terbiyecisi' tablosu kime aittir?","options":["Ä°brahim Ã‡allÄ±","Osman Hamdi Bey","Åeker Ahmet PaÅŸa","Hoca Ali RÄ±za"],"answer":"Osman Hamdi Bey"},{"type":"mcq","stem":"2020 Yaz OlimpiyatlarÄ± hangi ÅŸehirde dÃ¼zenlendi?","options":["Rio","Tokyo","Londra","Paris"],"answer":"Tokyo"}]};
// --- injected: force new bank and clear overrides ---
try { localStorage.removeItem('kv_question_bank_override_v1'); } catch(e) {}
Object.defineProperty(window, 'QUESTION_BANK', { value: QUESTION_BANK, writable: false, configurable: false });
// --- end injected ---


// KEYS
const KEY='mobiroller_categories_v2_tasks_v41';
const KEY_DONE='mobiroller_tasks_done_ids_v41';
const KEY_SEQ='mobiroller_cat_sequential_v41'; // 1 aÃ§Ä±k
const KEY_CAT_ORDER='mobiroller_cat_shuffle_v41'; // kategori listesi karÄ±ÅŸÄ±k
if(localStorage.getItem(KEY_SEQ)===null) localStorage.setItem(KEY_SEQ,'1');

// helpers
function getSeq(){ return (localStorage.getItem(KEY_SEQ)||'1')==='1'; }
function setSeq(v){ localStorage.setItem(KEY_SEQ, v?'1':'0'); }
function getCatShuffle(){ return localStorage.getItem(KEY_CAT_ORDER)==='1'; }
function setCatShuffle(v){ localStorage.setItem(KEY_CAT_ORDER, v?'1':'0'); }
function showToast(m){ const t=document.getElementById('toast'); const s=document.getElementById('toastMsg'); s.textContent=m; t.style.display='block'; t.style.opacity='0'; requestAnimationFrame(()=>{ t.style.transition='all .25s'; t.style.opacity='1'; }); setTimeout(()=>{ t.style.opacity='0'; setTimeout(()=>{t.style.display='none';},250); },1600); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; } return a; }

// storage
function load(){ return JSON.parse(localStorage.getItem(KEY)||'[]'); }
function save(d){ localStorage.setItem(KEY, JSON.stringify(d)); }
function loadDone(){ return new Set(JSON.parse(localStorage.getItem(KEY_DONE)||'[]')); }
function saveDone(set){ localStorage.setItem(KEY_DONE, JSON.stringify(Array.from(set))); }
function ensureDefaults(c){ if(!c) c={}; if(!Array.isArray(c.tasks)) c.tasks=[]; if(typeof c.rand!=='boolean') c.rand=false; if(typeof c.name!=='string') c.name='Kategori'; return c; }

// tabs
const tabSettings=document.getElementById('tabSettings');
const tabRun=document.getElementById('tabRun');
const viewSettings=document.getElementById('viewSettings');
const viewRun=document.getElementById('viewRun');
tabSettings.onclick=()=>{ tabSettings.classList.add('active'); tabRun.classList.remove('active'); viewSettings.style.display='block'; viewRun.style.display='none'; render(); };
tabRun.onclick=()=>{ tabRun.classList.add('active'); tabSettings.classList.remove('active'); viewSettings.style.display='none'; viewRun.style.display='block'; };

// toolbar
const btnExportHtml=document.getElementById('btnExportHtml');
const btnImportFile=document.getElementById('btnImportFile');
const importInput=document.getElementById('importInput');
const btnShuffleCats=document.getElementById('btnShuffleCats');
const btnResetDone=document.getElementById('btnResetDone');
const btnSeq=document.getElementById('btnSeq');
function refreshToolbar(){
  btnShuffleCats.textContent = 'Kategori SÄ±rasÄ±: ' + (getCatShuffle()?'KarÄ±ÅŸÄ±k':'Sabit');
  btnSeq.textContent = 'SÄ±ralÄ± Ä°lerleme: ' + (getSeq()?'AÃ§Ä±k':'KapalÄ±');
}
btnShuffleCats.onclick=()=>{ setCatShuffle(!getCatShuffle()); refreshToolbar(); };
btnResetDone.onclick=()=>{ if(!confirm('TÃ¼m tamamlanan iÅŸaretleri sÄ±fÄ±rlansÄ±n mÄ±?')) return; localStorage.setItem(KEY_DONE,'[]'); showToast('SÄ±fÄ±rlandÄ±'); render(); };
btnSeq.onclick=()=>{ setSeq(!getSeq()); refreshToolbar(); };
btnExportHtml.onclick=()=>{ const blob=new Blob([document.documentElement.outerHTML],{type:'text/html'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='gorev-timer-v2.41-stable.html'; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},800); };
btnImportFile.onclick=()=>importInput.click();
importInput.onchange=()=>{ alert('Bu sÃ¼rÃ¼mde dÄ±ÅŸa aktarÄ±m aktif, iÃ§e aktarÄ±m bir sonraki sÃ¼rÃ¼mde.'); importInput.value=''; };

// category UI
const catInput=document.getElementById('catInput');
const btnAddCat=document.getElementById('btnAddCat');
const catList=document.getElementById('catList');
btnAddCat.onclick=()=>{
  const name=(catInput.value||'').trim();
  if(!name){ showToast('Kategori adÄ± girin.'); return; }
  const data=load().map(ensureDefaults);
  data.push({name,rand:false,tasks:[]});
  save(data); catInput.value=''; render();
};

function render(){
  refreshToolbar();
  const data=load().map(ensureDefaults);
  catList.innerHTML='';
  if(!data.length){
    const li=document.createElement('li'); li.className='item'; li.innerHTML='<div class="small">HenÃ¼z kategori yok. Ãœstten ad yazÄ±p â€œ+ Kategori Ekleâ€.</div>'; catList.appendChild(li); return;
  }
  data.forEach((cat,ci)=>{
    const li=document.createElement('li'); li.className='item';
    li.innerHTML=`
      <div class="item-header">
        <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap">
          <input type="text" value="${cat.name||''}" data-ci="${ci}" class="cat-name"/>
          <div class="row" style="gap:6px;align-items:center">
            <span class="small">Kategori iÃ§i gÃ¶rev sÄ±ralamasÄ±</span>
            <select class="cat-order" data-ci="${ci}">
              <option value="fixed" ${cat.rand?'':'selected'}>Sabit</option>
              <option value="shuffle" ${cat.rand?'selected':''}>KarÄ±ÅŸÄ±k</option>
            </select>
          </div>
        </div>
        <div class="row" style="gap:6px">
          <button class="danger cat-del" data-ci="${ci}">Sil</button>
        </div>
      </div>
      <div class="task-form">
        <div class="task-grid">
          <input type="text" placeholder="GÃ¶rev BaÅŸlÄ±ÄŸÄ±" class="t-title" data-ci="${ci}"/>
          <select class="t-gender" data-ci="${ci}"><option value="">Cinsiyet (opsiyonel)</option><option value="K">KadÄ±n</option><option value="E">Erkek</option></select>
          <input type="number" min="5" max="900" value="30" class="t-duration" data-ci="${ci}" placeholder="SÃ¼re (sn)"/>
          <input type="text" placeholder="GÃ¶rsel URL (opsiyonel)" class="t-img" data-ci="${ci}"/>
        </div>
        <div class="task-grid-2">
          <input type="text" placeholder="GÃ¶rev Pozisyonu" class="t-position" data-ci="${ci}"/>
          <textarea placeholder="GÃ¶rev TalimatÄ±" class="t-instruction" data-ci="${ci}"></textarea>
        </div>
        <div class="task-actions">
          <button class="primary t-add" data-ci="${ci}">+ GÃ¶rev Ekle</button>
        </div>
      </div>
      <div class="task-list" id="task-list-${ci}"></div>
    `;
    catList.appendChild(li);

    li.querySelector('.cat-name').onchange=(e)=>{ const d=load().map(ensureDefaults); d[ci].name=e.target.value; save(d); };
    li.querySelector('.cat-order').onchange=(e)=>{ const d=load().map(ensureDefaults); d[ci].rand=(e.target.value==='shuffle'); save(d); };
    li.querySelector('.cat-del').onclick=()=>{ if(!confirm('Kategori silinsin mi?')) return; const d=load().map(ensureDefaults); d.splice(ci,1); save(d); render(); };
    li.querySelector('.t-add').onclick=()=>{
      const title=li.querySelector('.t-title').value.trim();
      const gender=li.querySelector('.t-gender').value||null;
      const dsec=parseInt(li.querySelector('.t-duration').value||'30',10)||30;
      const img=(li.querySelector('.t-img').value||'').trim()||null;
      const position=(li.querySelector('.t-position').value||'').trim();
      const instruction=(li.querySelector('.t-instruction').value||'').trim();
      if(!title){ showToast('GÃ¶rev baÅŸlÄ±ÄŸÄ± zorunlu'); return; }
      const d=load().map(ensureDefaults);
      const t={ id: Date.now()+Math.random().toString(16).slice(2), title, gender, d: dsec, img, position, instruction };
      d[ci].tasks.push(t); save(d);
      li.querySelector('.t-title').value=''; li.querySelector('.t-img').value=''; li.querySelector('.t-position').value=''; li.querySelector('.t-instruction').value='';
      renderTasks(ci);
    };
    renderTasks(ci);
  });
}

function renderTasks(ci){
  const data=load().map(ensureDefaults);
  const cat=data[ci];
  const wrap=document.getElementById('task-list-'+ci);
  const done=loadDone();
  wrap.innerHTML='';
  if(!cat.tasks.length){ wrap.innerHTML='<div class="small">Bu kategoride gÃ¶rev yok.</div>'; return; }
  cat.tasks.forEach((t,ti)=>{
    const row=document.createElement('div'); row.className='task-row';
    row.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div>
          <div class="task-title">${t.title}</div>
          <div class="task-meta">SÃ¼re: ${t.d||30} sn â€¢ ${t.gender?('Hedef: '+(t.gender==='K'?'KadÄ±n':'Erkek')):'Genel'}</div>
          <div class="task-meta">Pozisyon: ${t.position||'-'}</div>
          <div class="task-meta">Talimat: ${t.instruction||'-'}</div>
        </div>
        <div class="row" style="gap:6px">
          <button class="mark-done" data-ti="${ti}" ${done.has(t.id)?'disabled':''}>âœ“ TamamlandÄ±</button>
          <button class="edit" data-ti="${ti}">DÃ¼zenle</button>
          <button class="danger del" data-ti="${ti}">Sil</button>
        </div>
      </div>
    `;
    wrap.appendChild(row);
    row.querySelector('.del').onclick=()=>{ if(!confirm('GÃ¶rev silinsin mi?')) return; const d=load().map(ensureDefaults); d[ci].tasks.splice(ti,1); save(d); renderTasks(ci); };
    row.querySelector('.mark-done').onclick=()=>{ const ds=loadDone(); ds.add(t.id); saveDone(ds); renderTasks(ci); };
    row.querySelector('.edit').onclick=()=>{
      const title=prompt('BaÅŸlÄ±k', t.title)||t.title;
      const duration=parseInt(prompt('SÃ¼re (sn)', t.d||30)||t.d||30,10)||t.d||30;
      const gender=(prompt('Hedef (boÅŸ/K/E)', t.gender||'')||'').trim()||null;
      const pos=prompt('Pozisyon', t.position||'')||'';
      const ins=prompt('Talimat', t.instruction||'')||'';
      const d=load().map(ensureDefaults);
      Object.assign(d[ci].tasks[ti], {title: title.trim(), d: duration, gender, position: pos, instruction: ins});
      save(d); renderTasks(ci);
    };
  });
}

// Quiz/game (same as before, shortened timing parts)
const kvTimerEl=document.getElementById('kvTimer'), kvStemEl=document.getElementById('kvStem');
const kvImg=document.getElementById('kvImg'), kvAudio=document.getElementById('kvAudio');
const optEls=[document.getElementById('opt0'),document.getElementById('opt1'),document.getElementById('opt2'),document.getElementById('opt3')];
const kvNew=document.getElementById('kvNew'), kvSwap=document.getElementById('kvSwap'), kvTurnLbl=document.getElementById('kvTurnLbl');
const kFill=document.getElementById('kFill'), eFill=document.getElementById('eFill'); const kScoreLbl=document.getElementById('kScoreLbl'), eScoreLbl=document.getElementById('eScoreLbl');
const beep=document.getElementById('beep');
let kvTurn='K', kvRemain=30, kvTimer=null, kScore=0, eScore=0, currentCorrect=-1;
function doBeep(){ try{ beep.currentTime=0; beep.play(); }catch(e){} }
function kvUpd(){ kvTurnLbl.textContent=kvTurn==='K'?'KadÄ±n':'Erkek'; kFill.style.width=Math.min(100,(kScore/30)*100)+'%'; eFill.style.width=Math.min(100,(eScore/30)*100)+'%'; kScoreLbl.textContent=`${kScore} / 30`; eScoreLbl.textContent=`${eScore} / 30`; }
function pickQuestion(){ const it=QUESTION_BANK.items; const r=Math.random(); let p=it; if(r<.55)p=it.filter(q=>q.type==='mcq'); else if(r<.70)p=it.filter(q=>q.type==='image'); else if(r<.80)p=it.filter(q=>q.type==='audio'); else if(r<.90)p=it.filter(q=>q.type==='tf'); else p=it.filter(q=>q.type==='fill'||q.type==='logic'); if(!p.length)p=it; return p[(Math.random()*p.length)|0]; }
function renderQuestion(q){ kvImg.style.display='none'; kvAudio.style.display='none'; kvAudio.src=''; kvImg.src=''; kvStemEl.textContent=q.stem; if(q.type==='image'&&q.img){kvImg.src=q.img; kvImg.style.display='block';} if(q.type==='audio'&&q.audio){kvAudio.src=q.audio; kvAudio.style.display='block';} let options=q.options||[]; if(q.type==='tf') options=["DoÄŸru","YanlÄ±ÅŸ"]; while(options.length<4) options.push("â€”"); options=options.slice(0,4); currentCorrect=options.indexOf(q.answer); if(currentCorrect===-1){options[0]=q.answer; currentCorrect=0;} for(let i=0;i<4;i++){ optEls[i].style.display='flex'; optEls[i].disabled=false; optEls[i].classList.remove('opt-correct','opt-wrong'); optEls[i].querySelector('.txt').textContent=String(options[i]); } }
function kvStartQ(){ const q=pickQuestion(); renderQuestion(q); kvRemain=30; kvTimerEl.textContent=kvRemain; clearInterval(kvTimer); kvTimer=setInterval(()=>{ kvRemain--; if(kvRemain<=5 && kvRemain>0) doBeep(); if(kvRemain<=0){ clearInterval(kvTimer); kvTimer=null; endQuestion(false);} kvTimerEl.textContent=Math.max(0,kvRemain); },1000); }
function endQuestion(){ optEls.forEach(b=>b.disabled=true); setTimeout(()=>{ kvNext(); }, 350); }
function onChoose(i){ if(kvTimer){clearInterval(kvTimer); kvTimer=null;} if(i===currentCorrect){ optEls[i].classList.add('opt-correct'); if(kvTurn==='K')kScore+=10; else eScore+=10; } else { optEls[i].classList.add('opt-wrong'); if(currentCorrect>=0) optEls[currentCorrect].classList.add('opt-correct'); if(kvTurn==='K')kScore=Math.max(0,kScore-5); else eScore=Math.max(0,eScore-5); } if(kScore>=30){ kScore=0; kvUpd(); rewardNow('KadÄ±n'); } else if(eScore>=30){ eScore=0; kvUpd(); rewardNow('Erkek'); } kvUpd(); endQuestion(); }
optEls.forEach((b,i)=> b.onclick=()=>onChoose(i));
function kvNext(){ kvTurn = kvTurn==='K'?'E':'K'; kvUpd(); }
kvSwap.onclick=()=>{ kvTurn = kvTurn==='K'?'E':'K'; kvUpd(); };
kvNew.onclick=kvStartQ;

// Reward & wheel
const rewardDlg=document.getElementById('rewardDlg'); const rewardWho=document.getElementById('rewardWho');
const rewardTitle=document.getElementById('rewardTitle'); const rewardPos=document.getElementById('rewardPos'); const rewardInst=document.getElementById('rewardInst');
const rewardTimerEl=document.getElementById('rewardTimer'); const rewardStart=document.getElementById('rewardStart');
const rewardDone=document.getElementById('rewardDone'); const rewardSkip=document.getElementById('rewardSkip'); const rewardImg=document.getElementById('rewardImg');
let rewardRemain=30, rewardTick=null; let rewardCurrentTask=null;

function firstIncompleteCategoryIndex(){
  const d=load().map(ensureDefaults); const done=loadDone();
  for(let ci=0; ci<d.length; ci++){ const cat=d[ci]; if(!cat.tasks||!cat.tasks.length) continue; if(cat.tasks.some(t=>!done.has(t.id))) return ci; }
  return -1;
}
function pickFromCategory(ci){
  const d=load().map(ensureDefaults); const done=loadDone(); const cat=d[ci]; if(!cat||!cat.tasks||!cat.tasks.length) return null;
  const undone=cat.tasks.filter(t=>!done.has(t.id)); if(!undone.length) return null;
  const ch = cat.rand ? undone[(Math.random()*undone.length)|0] : undone[0];
  return {ci, ti: cat.tasks.indexOf(ch), t: ch, catName: cat.name};
}
function findNextTask(){
  if(getSeq()){ const idx=firstIncompleteCategoryIndex(); if(idx<0) return null; return pickFromCategory(idx); }
  const d=load().map(ensureDefaults); const order=[...Array(d.length).keys()]; if(getCatShuffle()) shuffle(order);
  for(const ci of order){ const p=pickFromCategory(ci); if(p) return p; } return null;
}
function openReward(who, picked){
  const sel = picked || findNextTask();
  if(!sel){ rewardWho.textContent='â€”'; rewardTitle.textContent='GÃ¶rev bulunamadÄ±'; rewardPos.textContent='Pozisyon: â€”'; rewardInst.textContent='Talimat: â€”'; rewardImg.style.display='none'; rewardRemain=30; rewardTimerEl.textContent=rewardRemain; rewardDlg.showModal(); return; }
  rewardCurrentTask=sel; rewardWho.textContent=who|| (sel.t.gender==='E' ? 'Erkek' : 'KadÄ±n');
  rewardTitle.textContent = sel.catName + ' â€¢ ' + sel.t.title;
  rewardPos.textContent = 'Pozisyon: ' + (sel.t.position||'-');
  rewardInst.textContent= 'Talimat: ' + (sel.t.instruction||'-');
  if(sel.t.img){ rewardImg.src=sel.t.img; rewardImg.style.display='block'; rewardImg.onerror=()=>{rewardImg.style.display='none';}; } else { rewardImg.style.display='none'; }
  rewardRemain= sel.t.d || 30; rewardTimerEl.textContent=rewardRemain; rewardDlg.showModal();
}
rewardStart.onclick=()=>{ clearInterval(rewardTick); rewardTick=setInterval(()=>{ rewardRemain--; if(rewardRemain<=5 && rewardRemain>0) doBeep(); if(rewardRemain<=0){ clearInterval(rewardTick); rewardTick=null; doBeep(); } rewardTimerEl.textContent=Math.max(0,rewardRemain); },1000); };
rewardDone.onclick=()=>{ clearInterval(rewardTick); rewardTick=null; if(rewardCurrentTask){ const set=loadDone(); set.add(rewardCurrentTask.t.id); saveDone(set); } rewardDlg.close(); };
rewardSkip.onclick=()=>{ clearInterval(rewardTick); rewardTick=null; rewardDlg.close(); };

const wheelDlg = document.getElementById('wheelDlg'); const wheelCanvas=document.getElementById('wheelCanvas'); const wheelSpin=document.getElementById('wheelSpin'); const wheelCancel=document.getElementById('wheelCancel');
const wctx=wheelCanvas.getContext('2d'); let wheelCats=[]; let wheelAngle=0; let spinning=false; let wheelWho='KadÄ±n';
const wheelResult=document.getElementById('wheelResult'); const wheelCdFill=document.getElementById('wheelCdFill'); const wheelCdLabel=document.getElementById('wheelCdLabel'); const wheelStop=document.getElementById('wheelStop');
function buildWheel(){
  const d=load().map(ensureDefaults); const done=loadDone();
  if(getSeq()){ const idx=firstIncompleteCategoryIndex(); if(idx<0){ wheelCats=[]; return; } const c=d[idx]; if(c.tasks.some(t=>!done.has(t.id))) wheelCats=[{name:c.name,ci:idx}]; else wheelCats=[]; return; }
  wheelCats=d.map((c,ci)=>({name:c.name,ci})).filter(x=>{ const cat=d[x.ci]; return (cat.tasks||[]).some(t=>!done.has(t.id)); });
}
function drawWheel(){
  const N=Math.max(1,wheelCats.length), R=wheelCanvas.width/2, cx=R, cy=R, slice=(Math.PI*2)/N;
  wctx.clearRect(0,0,wheelCanvas.width,wheelCanvas.height); wctx.save(); wctx.translate(cx,cy); wctx.rotate(wheelAngle);
  for(let i=0;i<N;i++){ wctx.beginPath(); wctx.moveTo(0,0); wctx.arc(0,0,R,i*slice,(i+1)*slice); wctx.closePath(); wctx.fillStyle=`hsl(${(i*360/N)|0},70%,45%)`; wctx.fill(); wctx.lineWidth=2; wctx.strokeStyle='#0b0c10'; wctx.stroke();
    wctx.save(); const mid=i*slice+slice/2; wctx.rotate(mid); wctx.textAlign='right'; wctx.fillStyle='#fff'; wctx.font='14px system-ui'; wctx.fillText(wheelCats[i%wheelCats.length]?.name||'â€”', R-10, 0); wctx.restore(); }
  wctx.restore(); wctx.beginPath(); wctx.moveTo(cx,6); wctx.lineTo(cx-8,20); wctx.lineTo(cx+8,20); wctx.closePath(); wctx.fillStyle='#4f8cff'; wctx.fill();
}
function openWheel(who){ wheelWho=who||'KadÄ±n'; buildWheel(); if(!wheelCats.length){ showToast('SeÃ§ilebilir kategori yok.'); return openReward(wheelWho); } wheelAngle=0; drawWheel(); wheelResult.style.display='none'; wheelDlg.showModal(); }
function startCountdown(picked){ wheelResult.style.display='block'; let cd=5; wheelCdFill.style.width='100%'; wheelCdLabel.textContent=cd+' sn'; const int=setInterval(()=>{ cd--; wheelCdFill.style.width=(Math.max(0,cd)/5*100)+'%'; wheelCdLabel.textContent=cd>0?cd+' sn':'AÃ§Ä±lÄ±yorâ€¦'; if(cd<=0){ clearInterval(int); setTimeout(()=>{ wheelDlg.close(); openReward(wheelWho, picked||undefined); },120);} },1000); wheelStop.onclick=()=>{ clearInterval(int); wheelResult.style.display='none'; }; }
function spin(){ if(spinning) return; spinning=true; const N=Math.max(1,wheelCats.length), slice=(Math.PI*2)/N; const extra=2+Math.random()*3; const target=(Math.random()*N)|0; const targetAngle=(Math.PI*2)*extra + (Math.PI/2) - (target*slice + slice/2); const start=performance.now(), dur=2400+Math.random()*800, startA=wheelAngle;
  const step=(t)=>{ const p=Math.min(1,(t-start)/dur); const eased=1-Math.pow(1-p,3); wheelAngle=startA+eased*(targetAngle-startA); drawWheel(); if(p<1) requestAnimationFrame(step); else { spinning=false; const pick=pickFromCategory(wheelCats[target].ci); startCountdown(pick);} }; requestAnimationFrame(step); }
wheelCancel.onclick=()=>wheelDlg.close(); wheelSpin.onclick=spin;

// triggers
function rewardNow(who){ openWheel(who); }
document.getElementById('btnNewGame').onclick=()=>{ if(!confirm('Yeni oyun? (tamamlanan gÃ¶revler sÄ±fÄ±rlanÄ±r)')) return; localStorage.setItem(KEY_DONE,'[]'); kScore=0; eScore=0; kvTurn='K'; if(kvTimer){clearInterval(kvTimer);kvTimer=null;} kvRemain=30; kvTimerEl.textContent=kvRemain; try{rewardDlg.close();}catch(e){} kvUpd(); showToast('Yeni oyun'); };

// init
render(); refreshToolbar();
</script>

<script>
// === injected: augment tasks with numbering + DnD reordering without breaking existing code ===
(function(){
  // keep original
  const _renderTasks = window.renderTasks;
  if(!_renderTasks) return;

  // helpers from page scope assumed: load(), save(), ensureDefaults()
  function renumber(wrap){
    const rows = Array.from(wrap.querySelectorAll('.task-row'));
    rows.forEach((row, i)=>{
      let num = row.querySelector('.task-num');
      if(!num){
        num = document.createElement('span');
        num.className = 'task-num';
        // put before title if possible
        const title = row.querySelector('.task-title');
        const container = title && title.parentElement ? title.parentElement : row;
        const handle = document.createElement('span'); handle.textContent='â†•'; handle.className='drag-handle';
        container.insertBefore(num, container.firstChild);
        container.insertBefore(handle, container.firstChild);
        row.setAttribute('draggable', 'true');
        row.addEventListener('dragstart', ()=> row.classList.add('dragging'));
        row.addEventListener('dragend', ()=> row.classList.remove('dragging'));
      }
      num.textContent = String(i+1);
    });
  }

  function attachDnD(ci, wrap){
    const data = load().map(ensureDefaults);
    const cat = data[ci];

    wrap.addEventListener('dragover', (e)=>{
      e.preventDefault();
      const dragging = wrap.querySelector('.task-row.dragging');
      if(!dragging) return;
      const after = getAfter(wrap, e.clientY);
      if(after==null) wrap.appendChild(dragging);
      else wrap.insertBefore(dragging, after);
    });

    wrap.addEventListener('drop', ()=>{
      // persist DOM order to state
      const orderEls = Array.from(wrap.querySelectorAll('.task-row'));
      // find each task's title to map back; safer: data-index via position in original render
      const original = cat.tasks.slice();
      const map = new Map();
      // try to identify by action buttons having data-ti
      orderEls.forEach(el=>{
        const delBtn = el.querySelector('.del[data-ti]');
        if(delBtn){
          map.set(el, parseInt(delBtn.getAttribute('data-ti'),10));
        } else {
          // fallback: by title text content
          const t = (el.querySelector('.task-title')?.textContent||'').trim();
          const idx = original.findIndex(x=>x.title===t && !x.__used);
          if(idx>-1){ original[idx].__used=true; map.set(el, idx); }
        }
      });
      const newTasks = orderEls.map(el=> cat.tasks[ map.get(el) ?? 0 ]).filter(Boolean);
      if(newTasks.length===cat.tasks.length){
        const d = load().map(ensureDefaults);
        d[ci].tasks = newTasks.map(t=>{ const c={...t}; delete c.__used; return c; });
        save(d);
      }
      renumber(wrap);
    });

    function getAfter(container, y){
      const els = [...container.querySelectorAll('.task-row:not(.dragging)')];
      let closest = null, closestOffset = Number.NEGATIVE_INFINITY;
      els.forEach(child=>{
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height/2;
        if(offset < 0 && offset > closestOffset){ closestOffset = offset; closest = child; }
      });
      return closest;
    }
  }

  window.renderTasks = function(ci){
    _renderTasks(ci);
    const wrap = document.getElementById('task-list-'+ci);
    if(!wrap) return;
    renumber(wrap);
    // only attach once
    if(!wrap.__dndAttached){ attachDnD(ci, wrap); wrap.__dndAttached = true; }
  };
})();
</script>


<script>
// === injected: importer for "SoruÅÄ±klarDoÄŸru Cevap" format ===
(function(){
  const LS_QB = 'kv_question_bank_override_v1';

  function parseUserQA(txt){
    const items = [];
    let i = 0, num = 1;
    function pick(re){ const m = re.exec(txt.slice(i)); if(!m) return null; m.index0=i+m.index; return m; }
    while(true){
      const mStem = pick(new RegExp(String(num).replace('.', '\\.') + String.raw`\.\s*([^?]+)\?`, 'm'));
      if(!mStem) break;
      const stem = mStem[1].trim();
      i = mStem.index0 + mStem[0].length;
      const mOpts = pick(/A\)\s*([^,]+),\s*B\)\s*([^,]+),\s*C\)\s*([^,]+),\s*D\)\s*([^\dA-D]+)/m);
      if(!mOpts) break;
      const A = mOpts[1].trim(), B = mOpts[2].trim(), C = mOpts[3].trim(), D = mOpts[4].trim().replace(/[,\s]+$/,'');
      i = mOpts.index0 + mOpts[0].length;
      const mAns = pick(/([A-D])\)\s*([^\d]+)/m) || pick(/([A-D])\)\s*/m);
      if(!mAns) break;
      const letter = mAns[1];
      i = mAns.index0 + mAns[0].length;
      const map = {A, B, C, D};
      items.push({type:'mcq', stem, options:[A,B,C,D], answer: map[letter]});
      num++;
      if(num>1000) break;
    }
    return items;
  }

  function saveOverride(bank){
    try { localStorage.setItem(LS_QB, JSON.stringify(bank)); } catch(e){}
  }
  function loadOverride(){
    try { return JSON.parse(localStorage.getItem(LS_QB)||'null'); } catch(e){ return null; }
  }

  // Hook question loader: if override exists, use it
  if(window.QUESTION_BANK){
    const ob = loadOverride();
    if(ob && Array.isArray(ob.items) && ob.items.length){
      window.QUESTION_BANK = ob;
    }
  }

  // Add button handler
  document.getElementById('btnImportQA')?.addEventListener('click', ()=>{
    const txt = prompt('Soru metnini buraya yapÄ±ÅŸtÄ±rÄ±n (format: "SoruÅÄ±klarDoÄŸru Cevap")\\nNot: Sadece A-D ÅŸÄ±klÄ± sorular desteklenir.');
    if(!txt) return;
    const items = parseUserQA(txt);
    if(!items.length){ alert('HiÃ§ soru algÄ±lanamadÄ±. LÃ¼tfen formatÄ± kontrol edin.'); return; }
    const bank = { count: items.length, items };
    saveOverride(bank);
    window.QUESTION_BANK = bank;
    alert(items.length + ' soru yÃ¼klendi. Oyun ekranÄ±nda yeni sorular kullanÄ±lacak.');
  });
})();
</script>


<script>
// --- injected: 2 oyuncu DoÄŸru/YanlÄ±ÅŸ Ã§izelgesi + geÃ§miÅŸ ---
(function(){
  const LSKEY = 'kv_stats_v1';
  function loadStats(){
    try{ return JSON.parse(localStorage.getItem(LSKEY)||'{"K":{"d":0,"y":0},"E":{"d":0,"y":0},"log":[]}'); }catch(e){ return {"K":{"d":0,"y":0},"E":{"d":0,"y":0},"log":[]}; }
  }
  function saveStats(s){ try{ localStorage.setItem(LSKEY, JSON.stringify(s)); }catch(e){} }
  const S = loadStats();
  const el = (id)=>document.getElementById(id);
  function renderBoard(){
    el('kvKDogru').textContent = S.K.d;
    el('kvKYanlis').textContent = S.K.y;
    el('kvEDogru').textContent = S.E.d;
    el('kvEYanlis').textContent = S.E.y;
    const log = el('kvLog'); if(!log) return;
    log.innerHTML = S.log.slice(-50).map(item=>{
      const who = item.turn==='K' ? 'KadÄ±n' : 'Erkek';
      const cls = item.correct ? 'kv-ok' : 'kv-no';
      const icon = item.correct ? 'âœ“' : 'âœ—';
      const stem = (item.stem||'').replace(/</g,'&lt;').slice(0,90);
      return `<div><span class="${cls}">${icon}</span> <b>${who}</b> â€” ${stem}</div>`;
    }).join('');
  }
  // expose reset helper (optional)
  window.kvResetStats = function(){ S.K.d=S.K.y=S.E.d=S.E.y=0; S.log=[]; saveStats(S); renderBoard(); };

  // capture current question stem by wrapping renderQuestion
  if (typeof renderQuestion === 'function'){
    const __renderQuestion = renderQuestion;
    window.renderQuestion = function(q){
      window.kvCurrentQ = q;
      return __renderQuestion(q);
    };
  }

  // wrap onChoose to update stats after original logic runs
  if (typeof onChoose === 'function'){
    const __onChoose = onChoose;
    window.onChoose = function(i){
      const turn = (typeof kvTurn!=='undefined') ? kvTurn : 'K';
      const correctNow = (typeof currentCorrect!=='undefined') ? (i===currentCorrect) : false;
      __onChoose(i);
      // Update stats after original updates
      if (turn==='K'){ S.K[ correctNow ? 'd' : 'y' ]++; }
      else { S.E[ correctNow ? 'd' : 'y' ]++; }
      S.log.push({turn:turn, correct:correctNow, stem:(window.kvCurrentQ && window.kvCurrentQ.stem)||null});
      saveStats(S);
      renderBoard();
    };
  }

  // render once at load
  document.addEventListener('DOMContentLoaded', renderBoard);
})();
</script>


<script>
// --- injected: Ã§ark ilerleme gÃ¶stergesi + manuel tetik ---
(function(){
  function updWheelBadges(){
    try{
      if(typeof kScore!=='undefined') document.getElementById('kvKWheel').textContent = 'Ã‡ark: ' + (kScore|0) + '/30';
      if(typeof eScore!=='undefined') document.getElementById('kvEWheel').textContent = 'Ã‡ark: ' + (eScore|0) + '/30';
    }catch(e){}
  }
  // Hook kvUpd if exists
  if (typeof kvUpd === 'function'){
    const __kvUpd = kvUpd;
    window.kvUpd = function(){ const r = __kvUpd(); updWheelBadges(); return r; };
  } else {
    // fallback: tick after DOM ready
    document.addEventListener('DOMContentLoaded', updWheelBadges);
  }
  // Manual trigger
  document.addEventListener('DOMContentLoaded', function(){
    const btn = document.getElementById('kvWheelTest');
    if(btn){
      btn.addEventListener('click', function(){
        const who = (typeof kvTurn!=='undefined' && kvTurn==='E') ? 'Erkek' : 'KadÄ±n';
        if (typeof rewardNow === 'function') rewardNow(who);
      });
    }
  });
})();
</script>


<script>
// --- injected: Ã§ark akÄ±ÅŸÄ± garantisi (30 puan -> Ã§ark -> kategori -> gÃ¶rev) ---
(function(){
  // 1) startCountdown garanti: bittiÄŸinde gÃ¶rev penceresini aÃ§
  if (typeof startCountdown === 'function') {
    const __startCountdown = startCountdown;
    window.startCountdown = function(picked){
      // picked: {ci, ti, t, catName}
      const res = __startCountdown(picked);
      // Ek gÃ¼vence: 5.2 sn sonra (geri sayÄ±m biter bitmez) gÃ¶revi aÃ§
      try {
        setTimeout(function(){
          if (typeof openReward === 'function') {
            openReward(window.wheelWho || 'KadÄ±n', picked);
          }
        }, 5200);
      } catch(e){}
      return res;
    };
  }

  // 2) 30 puan eÅŸiÄŸi: her onChoose sonrasÄ± kontrol (ek gÃ¼vence)
  if (typeof onChoose === 'function'){
    const __onChoose = onChoose;
    window.onChoose = function(i){
      __onChoose(i);
      try {
        const ks = (typeof kScore!=='undefined') ? kScore : 0;
        const es = (typeof eScore!=='undefined') ? eScore : 0;
        if (ks >= 30 || es >= 30) {
          const who = ks >= 30 ? 'KadÄ±n' : 'Erkek';
          if (typeof rewardNow === 'function') rewardNow(who);
        }
      } catch(e){}
    };
  }
})();
</script>


<script>
// --- injected: Yeni Oyun tam sÄ±fÄ±rlama + tekrar etmeyen sorular (deck) ---
(function(){
  // 0) helper: shuffle
  function shuffle(a){
    for(let i=a.length-1;i>0;i--){ const j=(Math.random()* (i+1))|0; [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  }

  // 1) Soru tekrarsÄ±z: pickQuestion() sarmalayÄ±p "deck" kullan
  if (typeof pickQuestion === 'function'){
    const __pickQuestion = pickQuestion;
    // HazÄ±r bir deck varsa oradan Ã§ek; yoksa yeni karÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ deck hazÄ±rla
    window.kvDeck = Array.isArray(window.kvDeck) ? window.kvDeck : null;
    window.kvDeckPos = typeof window.kvDeckPos==='number' ? window.kvDeckPos : 0;
    window.pickQuestion = function(){
      try{
        const N = (window.QUESTION_BANK && Array.isArray(window.QUESTION_BANK.items)) ? window.QUESTION_BANK.items.length : 0;
        if(!window.kvDeck || window.kvDeck.length !== N){
          window.kvDeck = shuffle(Array.from({length:N},(_,i)=>i));
          window.kvDeckPos = 0;
        }
        if(window.kvDeckPos >= window.kvDeck.length){
          // tÃ¼m sorular bitti; yeniden karÄ±ÅŸtÄ±r (veya "bitti" mesajÄ± gÃ¶sterilebilir)
          window.kvDeck = shuffle(window.kvDeck);
          window.kvDeckPos = 0;
        }
        const idx = window.kvDeck[window.kvDeckPos++];
        const q = window.QUESTION_BANK.items[idx];
        return q;
      }catch(e){
        // sorun olursa eski davranÄ±ÅŸa dÃ¶n
        return __pickQuestion();
      }
    };
  }

  // 2) Yeni Oyun: her ÅŸeyi sÄ±fÄ±rla
  function kvResetGame(){
    try{
      // Skor ve Ã§ark sayaÃ§larÄ±
      if(typeof kScore!=='undefined') kScore = 0;
      if(typeof eScore!=='undefined') eScore = 0;
      if(typeof kCnt!=='undefined') kCnt = 0;
      if(typeof eCnt!=='undefined') eCnt = 0;
      if(typeof kvTurn!=='undefined') kvTurn = 'K';

      // EkranÄ± gÃ¼ncelle (varsa)
      if(typeof kvUpd==='function') kvUpd();

      // Soru destesi sÄ±fÄ±rla
      window.kvDeck = null;
      window.kvDeckPos = 0;

      // 2 oyuncu D/Y Ã§izelgesi
      try{
        const zero = {"K":{"d":0,"y":0},"E":{"d":0,"y":0},"log":[]};
        localStorage.setItem('kv_stats_v1', JSON.stringify(zero));
      }catch(e){}
      if(typeof kvResetStats==='function') kvResetStats();

      // Ã‡ark dialogu kapalÄ± olsun
      try{ document.getElementById('rewardDlg')?.close(); }catch(e){}

      // Bir sonraki soruyu getir
      if(typeof kvNext==='function') kvNext();
    }catch(e){ console.warn('kvResetGame error', e); }
  }

  // 3) "Yeni Oyun" butonuna baÄŸla (id varsa Ã¶ncelikli)
  function bindNewGame(){
    let btn = document.getElementById('kvNewGame') 
           || document.querySelector('button#kvNewGame');
    if(!btn){
      // fallback: metin ile ara
      const cand = Array.from(document.querySelectorAll('button')).find(b => (b.textContent||'').trim().toLowerCase().includes('yeni oyun'));
      if(cand) btn = cand;
    }
    if(btn && !btn.__kvBind){
      btn.__kvBind = true;
      btn.addEventListener('click', function(e){
        e.preventDefault();
        kvResetGame();
      });
    }
  }

  document.addEventListener('DOMContentLoaded', bindNewGame);
})();
</script>


<script>
// --- injected: Yeni Oyun tam sÄ±fÄ±r + skorlu geÃ§miÅŸ (Â±10/Â±20) ---
(function(){
  const LSKEY = 'kv_stats_v1';

  // migrate or init stats object
  function loadStats(){
    let s;
    try{ s = JSON.parse(localStorage.getItem(LSKEY)||'null'); }catch(e){ s=null; }
    if(!s || typeof s!=='object') s = {"K":{"d":0,"y":0,"s":0},"E":{"d":0,"y":0,"s":0},"log":[]};
    if(!s.K) s.K={"d":0,"y":0,"s":0};
    if(!s.E) s.E={"d":0,"y":0,"s":0};
    if(typeof s.K.s!=='number') s.K.s=0;
    if(typeof s.E.s!=='number') s.E.s=0;
    if(!Array.isArray(s.log)) s.log=[];
    return s;
  }
  function saveStats(S){ try{ localStorage.setItem(LSKEY, JSON.stringify(S)); }catch(e){} }

  const S = loadStats();
  const el = (id)=>document.getElementById(id);

  function renderBoard(){
    // pills already show D/Y counts; we add scoreboard in the "Soru GeÃ§miÅŸi" baÅŸlÄ±ÄŸÄ± altÄ±na
    try{
      el('kvKDogru').textContent = S.K.d;
      el('kvKYanlis').textContent = S.K.y;
      el('kvEDogru').textContent = S.E.d;
      el('kvEYanlis').textContent = S.E.y;
    }catch(e){}
    const log = el('kvLog'); if(!log) return;
    const header = `<div style="margin-bottom:6px">
        <b>Skor</b> â€” KadÄ±n: <span class="kv-pill">${S.K.s}</span> â€¢ Erkek: <span class="kv-pill">${S.E.s}</span>
      </div>`;
    log.innerHTML = header + S.log.slice(-80).map(item=>{
      const who = item.turn==='K' ? 'KadÄ±n' : 'Erkek';
      const sign = item.delta>0 ? '+' : '';
      const cls = item.delta>0 ? 'kv-ok' : 'kv-no';
      const stem = (item.stem||'').replace(/</g,'&lt;').slice(0,90);
      return `<div><span class="${cls}">${sign}${item.delta}</span> <b>${who}</b> â€” ${item.type||'Soru'} â€” ${stem}</div>`;
    }).join('');
  }

  // expose reset helper
  window.kvResetStats = function(){ S.K={d:0,y:0,s:0}; S.E={d:0,y:0,s:0}; S.log=[]; saveStats(S); renderBoard(); };

  // --- Wrap renderQuestion to keep current stem ---
  if (typeof renderQuestion === 'function'){
    const __renderQuestion = renderQuestion;
    window.renderQuestion = function(q){ window.kvCurrentQ = q; return __renderQuestion(q); };
  }

  // --- Hook onChoose for kelime avÄ±: doÄŸru=+10, yanlÄ±ÅŸ=-10 ---
  if (typeof onChoose === 'function'){
    const __onChoose = onChoose;
    window.onChoose = function(i){
      const turn = (typeof kvTurn!=='undefined') ? kvTurn : 'K';
      const wasCorrect = (typeof currentCorrect!=='undefined') ? (i===currentCorrect) : false;
      __onChoose(i); // original updates (puan barlarÄ±, Ã§ark eÅŸiÄŸi vs.)
      const delta = wasCorrect ? +10 : -10;
      if (turn==='K'){
        if(wasCorrect) S.K.d++; else S.K.y++;
        S.K.s += delta;
      } else {
        if(wasCorrect) S.E.d++; else S.E.y++;
        S.E.s += delta;
      }
      S.log.push({turn:turn, delta:delta, type:'Kelime AvÄ±', stem:(window.kvCurrentQ && window.kvCurrentQ.stem)||null});
      saveStats(S); renderBoard();
    };
  }

  // --- Hook reward buttons: TamamlandÄ±=+20, Pas=-20 ---
  document.addEventListener('DOMContentLoaded', function(){
    const btnDone = document.getElementById('rewardDone');
    const btnSkip = document.getElementById('rewardSkip');
    function addReward(delta, type){
      const turn = (typeof window.wheelWho==='string' && (window.wheelWho==='KadÄ±n'||window.wheelWho==='Erkek'))
                    ? (window.wheelWho==='KadÄ±n'?'K':'E')
                    : ((typeof kvTurn!=='undefined' && kvTurn==='E') ? 'E':'K');
      if (turn==='K') S.K.s += delta; else S.E.s += delta;
      S.log.push({turn:turn, delta:delta, type:type, stem:(window.rewardCurrentTask && window.rewardCurrentTask.t && window.rewardCurrentTask.t.title)||'GÃ¶rev'});
      saveStats(S); renderBoard();
    }
    if(btnDone && !btnDone.__kvPatch){
      btnDone.__kvPatch = true;
      btnDone.addEventListener('click', function(){ addReward(+20, 'Ã–zel GÃ¶rev (TamamlandÄ±)'); });
    }
    if(btnSkip && !btnSkip.__kvPatch){
      btnSkip.__kvPatch = true;
      btnSkip.addEventListener('click', function(){ addReward(-20, 'Ã–zel GÃ¶rev (Pas)'); });
    }
  });

  // --- Yeni Oyun: KEY_DONE dahil tam sÄ±fÄ±rla ve ekranÄ± yenile ---
  function kvResetGameFull(){
    try{
      // 1) tamamlanan gÃ¶rev setini temizle
      try{ localStorage.setItem('kv_done_v1','[]'); }catch(e){}
      // farklÄ± anahtar adÄ± kullanÄ±lÄ±yorsa (KEY_DONE) onu da sil
      try{
        // naive: clear all keys that look like *_done*
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if(/done/i.test(k)) localStorage.setItem(k,'[]');
        }
      }catch(e){}
      // 2) skor/turn/sayaÃ§lar
      if(typeof kScore!=='undefined') kScore = 0;
      if(typeof eScore!=='undefined') eScore = 0;
      if(typeof kCnt!=='undefined') kCnt = 0;
      if(typeof eCnt!=='undefined') eCnt = 0;
      if(typeof kvTurn!=='undefined') kvTurn = 'K';
      if(typeof kvTimer!=='undefined' && kvTimer){ clearInterval(kvTimer); kvTimer=null; }
      // 3) deck
      window.kvDeck = null; window.kvDeckPos = 0;
      // 4) log & DY & skor
      S.K={d:0,y:0,s:0}; S.E={d:0,y:0,s:0}; S.log=[]; saveStats(S);
      // 5) UI refresh: render all category task lists & top bars
      try{
        const dataLen = (function(){ try{ return (load()||[]).length; } catch(e){ return 0; } })();
        for(let ci=0; ci<dataLen; ci++){ try{ renderTasks(ci); }catch(e){} }
      }catch(e){}
      if(typeof kvUpd==='function') kvUpd();
      // 6) Ã§ark/gÃ¶rev dialoglarÄ± kapansÄ±n
      try{ document.getElementById('rewardDlg')?.close(); }catch(e){}
      try{ document.getElementById('wheelDlg')?.close(); }catch(e){}
      // 7) yeni soru
      if(typeof kvNext==='function') kvNext();
      renderBoard();
    }catch(e){ console.warn('kvResetGameFull error', e); }
  }

  // baÄŸla: var olan "Yeni Oyun" butonu
  document.addEventListener('DOMContentLoaded', function(){
    let btn = document.getElementById('btnNewGame') || document.getElementById('kvNewGame');
    if(!btn){
      btn = Array.from(document.querySelectorAll('button')).find(b => (b.textContent||'').trim().toLowerCase().includes('yeni oyun'));
    }
    if(btn && !btn.__kvFull){
      btn.__kvFull = true;
      btn.addEventListener('click', function(e){ e.preventDefault(); kvResetGameFull(); });
    }
  });

  // ilk Ã§izim
  document.addEventListener('DOMContentLoaded', renderBoard);
})();
</script>


<script>
// --- injected: 'TamamlananlarÄ± SÄ±fÄ±rla' dÃ¼ÄŸmesi onarÄ±mÄ± ---
(function(){
  function clearDoneKeys(){
    try{
      // Bilinen anahtar
      localStorage.setItem('kv_done_v1','[]');
      // OlasÄ± varyasyonlar: done listelerini boÅŸalt
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(/done/i.test(k)) try{ localStorage.setItem(k,'[]'); }catch(e){}
      }
    }catch(e){}
  }
  function refreshAllTaskLists(){
    try{
      // renderTasks(ci) iÃ§in kategori sayÄ±sÄ±nÄ± tahmin et
      let totalCats = 0;
      try{ totalCats = (load()||[]).length; }catch(e){ totalCats = 0; }
      for(let ci=0; ci<totalCats; ci++){ try{ renderTasks(ci); }catch(e){} }
    }catch(e){}
  }
  function bindResetDone(){
    // Ã–nce id ile deneyelim
    let btn = document.getElementById('btnResetDone');
    if(!btn){
      // metne gÃ¶re eÅŸleÅŸme
      btn = Array.from(document.querySelectorAll('button')).find(b => (b.textContent||'').trim().toLowerCase().includes('tamamlananlarÄ± sÄ±fÄ±rla'));
    }
    if(btn && !btn.__kvBind){
      btn.__kvBind = true;
      btn.addEventListener('click', function(e){
        e.preventDefault();
        clearDoneKeys();
        refreshAllTaskLists();
      });
    }
  }
  document.addEventListener('DOMContentLoaded', bindResetDone);
})();
</script>


<script>
// --- injected: Ã–zel gÃ¶rev skorunu doÄŸru oyuncuya yaz (performer-binding) ---
(function(){
  // 1) Yakala: Ã§ark/gÃ¶rev aÃ§Ä±lÄ±rken gÃ¶rev oyuncusunu kilitle
  if (typeof rewardNow === 'function'){
    const __rewardNow = rewardNow;
    window.rewardNow = function(who){
      // who: 'KadÄ±n' | 'Erkek'
      window.kvRewardPlayer = (who==='Erkek' ? 'E' : 'K');
      return __rewardNow(who);
    };
  }
  if (typeof openReward === 'function'){
    const __openReward = openReward;
    window.openReward = function(who, picked){
      // who: 'KadÄ±n' | 'Erkek'  (ek gÃ¼vence)
      window.kvRewardPlayer = (who==='Erkek' ? 'E' : 'K');
      // picked.t -> gÃ¶revin objesi ise saklayalÄ±m (log iÃ§in)
      try { window.rewardCurrentTask = picked; } catch(e){}
      return __openReward(who, picked);
    };
  }

  // 2) Skor gÃ¼ncellemesini hep kilitli oyuncuya yaz
  document.addEventListener('DOMContentLoaded', function(){
    const btnDone = document.getElementById('rewardDone');
    const btnSkip = document.getElementById('rewardSkip');
    function addReward(delta, type){
      try{
        const S = JSON.parse(localStorage.getItem('kv_stats_v1')||'{"K":{"d":0,"y":0,"s":0},"E":{"d":0,"y":0,"s":0},"log":[]}');
        const turn = window.kvRewardPlayer || (window.wheelWho==='Erkek'?'E':'K');
        if (turn==='K') S.K.s += delta; else S.E.s += delta;
        const stem = (window.rewardCurrentTask && window.rewardCurrentTask.t && window.rewardCurrentTask.t.title) || 'GÃ¶rev';
        S.log.push({turn:turn, delta:delta, type:type, stem:stem});
        localStorage.setItem('kv_stats_v1', JSON.stringify(S));
        // ekranda da gÃ¼ncelle
        try{
          document.getElementById('kvLog').dispatchEvent(new Event('kv-render'));
        }catch(e){}
      }catch(e){}
    }
    if(btnDone && !btnDone.__kvBind2){
      btnDone.__kvBind2 = true;
      btnDone.addEventListener('click', function(){ addReward(+20, 'Ã–zel GÃ¶rev (TamamlandÄ±)'); });
    }
    if(btnSkip && !btnSkip.__kvBind2){
      btnSkip.__kvBind2 = true;
      btnSkip.addEventListener('click', function(){ addReward(-20, 'Ã–zel GÃ¶rev (Pas)'); });
    }
  });

  // 3) kvLog yeniden Ã§izimi iÃ§in kÃ¼Ã§Ã¼k event tetikleyici
  document.addEventListener('DOMContentLoaded', function(){
    const log = document.getElementById('kvLog');
    if(!log) return;
    log.addEventListener('kv-render', function(){
      try{
        const S = JSON.parse(localStorage.getItem('kv_stats_v1')||'{"K":{"d":0,"y":0,"s":0},"E":{"d":0,"y":0,"s":0},"log":[]}');
        const header = `<div style="margin-bottom:6px">
            <b>Skor</b> â€” KadÄ±n: <span class="kv-pill">${S.K.s||0}</span> â€¢ Erkek: <span class="kv-pill">${S.E.s||0}</span>
          </div>`;
        log.innerHTML = header + (S.log||[]).slice(-80).map(item=>{
          const who = item.turn==='K' ? 'KadÄ±n' : 'Erkek';
          const sign = item.delta>0 ? '+' : '';
          const cls = item.delta>0 ? 'kv-ok' : 'kv-no';
          const stem = (item.stem||'').replace(/</g,'&lt;').slice(0,90);
          return `<div><span class="${cls}">${sign}${item.delta}</span> <b>${who}</b> â€” ${item.type||'Soru'} â€” ${stem}</div>`;
        }).join('');
        // Ã¼stteki kÃ¼Ã§Ã¼k pill'leri de gÃ¼ncelle
        const kd = document.getElementById('kvKDogru'); if(kd) kd.textContent = S.K.d||0;
        const ky = document.getElementById('kvKYanlis'); if(ky) ky.textContent = S.K.y||0;
        const ed = document.getElementById('kvEDogru'); if(ed) ed.textContent = S.E.d||0;
        const ey = document.getElementById('kvEYanlis'); if(ey) ey.textContent = S.E.y||0;
      }catch(e){}
    });
  });
})();
</script>


<script>
// --- injected: Ã‡ark tetikleyicide doÄŸru oyuncu (pre-turn) ---
(function(){
  if (typeof onChoose === 'function'){
    const __onChoose_orig = onChoose;
    window.onChoose = function(i){
      // capture BEFORE original toggles turn/score resets
      const preTurn = (typeof kvTurn!=='undefined') ? kvTurn : 'K'; // 'K'|'E'
      const preK = (typeof kScore!=='undefined') ? kScore : 0;
      const preE = (typeof eScore!=='undefined') ? eScore : 0;

      __onChoose_orig(i); // this may flip turn

      try{
        // avoid double open
        if (window.__kvWheelPending) return;
        // did someone reach threshold? determine by pre-turn owner
        const reached = (preTurn==='K') ? ((typeof kScore!=='undefined') && kScore>=30)
                                        : ((typeof eScore!=='undefined') && eScore>=30);
        if (reached && typeof rewardNow==='function'){
          window.__kvWheelPending = true;
          const who = (preTurn==='K') ? 'KadÄ±n' : 'Erkek';
          rewardNow(who);
          // clear flag shortly after open
          setTimeout(() => { window.__kvWheelPending = false; }, 1000);
        }
      }catch(e){}
    };
  }
})();
</script>

</body>
</
<!-- === KV PATCH v5: HTML export with embedded JSON + tolerant HTML import === -->
<script>
(function(){
  const KEY='mobiroller_categories_v2_tasks_v41';
  const KEY_DONE='mobiroller_tasks_done_ids_v41';

  function getCats(){ try{ const d=JSON.parse(localStorage.getItem(KEY)||'[]'); return Array.isArray(d)?d:[]; }catch(e){ return []; } }
  function getDone(){ try{ const d=JSON.parse(localStorage.getItem(KEY_DONE)||'[]'); return Array.isArray(d)?d:[]; }catch(e){ return []; } }

  document.addEventListener('DOMContentLoaded', function(){
    // 1) Override "Yedekli HTML indir" to embed JSON markers
    const btn = document.getElementById('btnExportHtml');
    if(btn && !btn.__kvV5){
      btn.__kvV5 = true;
      btn.addEventListener('click', function(ev){
        ev.preventDefault();
        // take current document HTML and inject JSON block before </body>
        const payload = { version:'v2.41', exportedAt:new Date().toISOString(), categories:getCats(), done:getDone() };
        let html = document.documentElement.outerHTML;
        const marker = '\\n<!-- KV-DATA-JSON-START -->\\n' + JSON.stringify(payload) + '\\n<!-- KV-DATA-JSON-END -->\\n';
        const idx = html.toLowerCase().lastIndexOf('</body>');
        if(idx>-1){ html = html.slice(0,idx) + marker + html.slice(idx); }
        const blob = new Blob([html], {type:'text/html'});
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download='gorev-timer-v2.41-backup.html';
        document.body.appendChild(a); a.click();
        setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},800);
      }, true);
    }

    // 2) Make import accept our embedded HTML backups
    const importInput = document.getElementById('importInput');
    if(importInput && !importInput.__kvV5){
      importInput.__kvV5 = true;
      importInput.addEventListener('change', async function(ev){
        const f = ev.target.files && ev.target.files[0];
        if(!f) return;
        try{
          const txt = await f.text();
          let obj=null;
          try{ obj = JSON.parse(txt); }catch(e){ obj=null; }
          if(!obj){
            // try markers
            const m = txt.match(/<!--\s*KV-DATA-JSON-START\s*-->([\s\S]*?)<!--\s*KV-DATA-JSON-END\s*-->/i);
            if(m){ try{ obj = JSON.parse(m[1]); }catch(e){ obj=null; } }
          }
          if(!obj){ alert('Dosya okunamadÄ±. LÃ¼tfen JSON yedeÄŸini veya "Yedekli HTML indir" ile alÄ±nan HTML dosyasÄ±nÄ± kullanÄ±n.'); ev.target.value=''; return; }
          const cats = Array.isArray(obj) ? obj : (Array.isArray(obj.categories)? obj.categories : []);
          const done = Array.isArray(obj.done)? obj.done : [];
          if(!cats.length){ alert('Ä°Ã§e aktarÄ±lacak kategori bulunamadÄ±.'); ev.target.value=''; return; }
          localStorage.setItem(KEY, JSON.stringify(cats));
          localStorage.setItem(KEY_DONE, JSON.stringify(done));
          (window.kvResetStats||(()=>{}))();
          if(typeof window.kvUpd==='function') window.kvUpd();
          if(typeof window.render==='function') window.render();
          (window.showToast||alert)('Ä°Ã§e aktarÄ±ldÄ±');
        }catch(err){
          alert('Ä°Ã§e aktarma baÅŸarÄ±sÄ±z: ' + (err && err.message || 'bilinmeyen hata'));
        }finally{
          ev.target.value='';
        }
      });
    }
  });
})();
</script>
<!-- === /KV PATCH v5 === -->

<!-- === KV PATCH v4: Kill old import onchange + override New Game onclick === -->
<script>
(function(){
  const KEY_DONE='mobiroller_tasks_done_ids_v41';
  const LS_STATS='kv_stats_v1';

  function clearDoneAll(){
    try{ localStorage.setItem(KEY_DONE,'[]'); }catch(e){}
    try{
      for(let i=localStorage.length-1;i>=0;i--){
        const k = localStorage.key(i);
        if(/_done/i.test(k)) try{ localStorage.removeItem(k); }catch(e){}
      }
    }catch(e){}
  }
  function resetStats(){
    try{ localStorage.setItem(LS_STATS, JSON.stringify({"K":{"d":0,"y":0,"s":0},"E":{"d":0,"y":0,"s":0},"log":[]})); }catch(e){}
    try{ window.kvResetStats && window.kvResetStats(); }catch(e){}
  }
  function resetGameStateOnly(){
    try{
      if(typeof window.kScore!=='undefined') window.kScore=0;
      if(typeof window.eScore!=='undefined') window.eScore=0;
      if(typeof window.kvTurn!=='undefined') window.kvTurn='K';
      if(typeof window.kvTimer!=='undefined' && window.kvTimer){ clearInterval(window.kvTimer); window.kvTimer=null; }
      const t=document.getElementById('kvTimer'); if(t) t.textContent='30';
      window.kvDeck=null; window.kvDeckPos=0;
      try{ document.getElementById('rewardDlg')?.close(); }catch(e){}
      try{ document.getElementById('wheelDlg')?.close(); }catch(e){}
      if(typeof window.kvUpd==='function') window.kvUpd();
    }catch(e){}
  }
  function refreshAll(){
    try{ window.render && window.render(); }catch(e){}
    try{ window.refreshToolbar && window.refreshToolbar(); }catch(e){}
    try{ window.kvUpd && window.kvUpd(); }catch(e){}
  }

  document.addEventListener('DOMContentLoaded', function(){
    // 1) Fix IMPORT: remove old inline onchange, then bind our parser
    const importInput = document.getElementById('importInput');
    const btnImportFile = document.getElementById('btnImportFile');
    if(importInput){
      try{ importInput.onchange = null; }catch(e){} // kill "Bu sÃ¼rÃ¼mde dÄ±ÅŸa aktarÄ±m..." alert handler
    }
    if(btnImportFile && importInput && !btnImportFile.__kvV4){
      btnImportFile.__kvV4 = true;
      btnImportFile.addEventListener('click', ()=> importInput.click());
      importInput.addEventListener('change', async function(ev){
        const f = ev.target.files && ev.target.files[0];
        if(!f){ return; }
        try{
          const text = await f.text();
          let obj=null;
          try{ obj = JSON.parse(text); }catch(e){ obj=null; }
          if(!obj && /<html/i.test(text)){
            const m = text.match(/<!--\s*KV-DATA-JSON-START\s*-->([\s\S]*?)<!--\s*KV-DATA-JSON-END\s*-->/i);
            if(m){ try{ obj = JSON.parse(m[1]); }catch(e){ obj=null; } }
          }
          if(!obj){ alert('JSON verisi bulunamadÄ±. LÃ¼tfen DÄ±ÅŸa Aktar (JSON) dosyasÄ±nÄ± yÃ¼kleyin.'); ev.target.value=''; return; }
          const cats = Array.isArray(obj) ? obj : (Array.isArray(obj.categories) ? obj.categories : []);
          const done = Array.isArray(obj.done) ? obj.done : [];
          if(!cats.length){ alert('Ä°Ã§e aktarÄ±lacak kategori bulunamadÄ±.'); ev.target.value=''; return; }
          localStorage.setItem('mobiroller_categories_v2_tasks_v41', JSON.stringify(cats));
          localStorage.setItem(KEY_DONE, JSON.stringify(done));
          resetStats();
          resetGameStateOnly();
          refreshAll();
          (window.showToast||alert)('Ä°Ã§e aktarÄ±ldÄ±');
        }catch(err){
          alert('Ä°Ã§e aktarÄ±lamadÄ±: ' + (err && err.message || 'bilinmeyen hata'));
        }finally{
          ev.target.value='';
        }
      });
    }

    // 2) Override New Game: replace inline onclick entirely
    const btnNG = document.getElementById('btnNewGame');
    if(btnNG && !btnNG.__kvV4){
      btnNG.__kvV4 = true;
      try{ btnNG.onclick = null; }catch(e){} // remove original inline handler
      btnNG.addEventListener('click', function(ev){
        ev.preventDefault();
        if(confirm('Yeni oyun? (tamamlananlar, skor ve geÃ§miÅŸ sÄ±fÄ±rlanÄ±r)')){
          clearDoneAll();
          resetStats();
          resetGameStateOnly();
          refreshAll();
          (window.showToast||alert)('Yeni oyun');
        }
      });
    }
  });
})();
</script>
<!-- === /KV PATCH v4 === -->

<!-- === KV PATCH v3: Working Import/Export(JSON) + Rock-solid New Game Reset === -->
<script>
(function(){
  const KEY='mobiroller_categories_v2_tasks_v41';
  const KEY_DONE='mobiroller_tasks_done_ids_v41';
  const LS_STATS='kv_stats_v1';

  // ---------- Robust helpers ----------
  function showToastSafe(msg){
    try{ (window.showToast||(()=>{}))(msg); }catch(e){ alert(msg); }
  }
  function loadCats(){
    try{
      const d = JSON.parse(localStorage.getItem(KEY)||'[]');
      return Array.isArray(d) ? d : [];
    }catch(e){ return []; }
  }
  function saveCats(d){
    localStorage.setItem(KEY, JSON.stringify(d||[]));
  }
  function clearDoneAll(){
    try{ localStorage.setItem(KEY_DONE,'[]'); }catch(e){}
    try{
      for(let i=localStorage.length-1;i>=0;i--){
        const k = localStorage.key(i);
        if(/_done/i.test(k)) try{ localStorage.removeItem(k); }catch(e){}
      }
    }catch(e){}
  }
  function resetStats(){
    try{ localStorage.setItem(LS_STATS, JSON.stringify({"K":{"d":0,"y":0,"s":0},"E":{"d":0,"y":0,"s":0},"log":[]})); }catch(e){}
    try{ window.kvResetStats && window.kvResetStats(); }catch(e){}
  }
  function refreshAll(){
    try{ window.render && window.render(); }catch(e){}
    try{ window.refreshToolbar && window.refreshToolbar(); }catch(e){}
    try{ window.kvUpd && window.kvUpd(); }catch(e){}
    try{
      // Re-enable disabled "TamamlandÄ±" buttons, in case the DOM kept state
      document.querySelectorAll('button.mark-done[disabled]').forEach(b=> b.removeAttribute('disabled'));
    }catch(e){}
  }
  function resetGameStateOnly(){
    try{
      if(typeof window.kScore!=='undefined') window.kScore=0;
      if(typeof window.eScore!=='undefined') window.eScore=0;
      if(typeof window.kvTurn!=='undefined') window.kvTurn='K';
      if(typeof window.kvTimer!=='undefined' && window.kvTimer){ clearInterval(window.kvTimer); window.kvTimer=null; }
      const t=document.getElementById('kvTimer'); if(t) t.textContent='30';
      window.kvDeck=null; window.kvDeckPos=0;
      try{ document.getElementById('rewardDlg')?.close(); }catch(e){}
      try{ document.getElementById('wheelDlg')?.close(); }catch(e){}
    }catch(e){}
  }

  // ---------- Import / Export ----------
  const btnExportJson = document.getElementById('btnExportJson');
  if(btnExportJson && !btnExportJson.__kvBind){
    btnExportJson.__kvBind = true;
    btnExportJson.addEventListener('click', function(){
      const payload = {
        version: 'v2.41',
        exportedAt: new Date().toISOString(),
        categories: loadCats(),
        done: (function(){ try{ return JSON.parse(localStorage.getItem(KEY_DONE)||'[]'); }catch(e){ return []; } })()
      };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='gorev-timer-data.json';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},800);
    });
  }

  const importInput = document.getElementById('importInput');
  const btnImportFile = document.getElementById('btnImportFile');
  if(btnImportFile && importInput && !btnImportFile.__kvBind){
    btnImportFile.__kvBind = true;
    btnImportFile.addEventListener('click', ()=> importInput.click());
    importInput.addEventListener('change', async function(ev){
      const f = ev.target.files && ev.target.files[0];
      if(!f){ return; }
      try{
        const text = await f.text();
        let obj=null;

        // Try JSON first
        try{ obj = JSON.parse(text); }catch(e){ obj=null; }

        // If HTML, try to extract a JSON blob between special markers
        if(!obj && /<html/i.test(text)){
          const m = text.match(/<!--\s*KV-DATA-JSON-START\s*-->([\s\S]*?)<!--\s*KV-DATA-JSON-END\s*-->/i);
          if(m){
            try{ obj = JSON.parse(m[1]); }catch(e){ obj=null; }
          }
        }

        if(!obj){
          alert('Dosya okunamadÄ±. LÃ¼tfen JSON dÄ±ÅŸa aktarma dosyasÄ±nÄ± kullanÄ±n.');
          ev.target.value='';
          return;
        }

        // Accept either {categories:[...], done:[...]} or raw array
        const cats = Array.isArray(obj) ? obj : (Array.isArray(obj.categories) ? obj.categories : []);
        const done = Array.isArray(obj.done) ? obj.done : [];

        if(!cats.length){
          alert('Ä°Ã§e aktarmada kategori verisi bulunamadÄ±.');
          ev.target.value='';
          return;
        }

        saveCats(cats);
        try{ localStorage.setItem(KEY_DONE, JSON.stringify(done)); }catch(e){}

        resetStats(); // temiz skor
        resetGameStateOnly();
        refreshAll();
        showToastSafe('Ä°Ã§e aktarÄ±ldÄ±');

      }catch(err){
        console.error(err);
        alert('Ä°Ã§e aktarma baÅŸarÄ±sÄ±z: ' + (err && err.message ? err.message : 'bilinmeyen hata'));
      }finally{
        ev.target.value='';
      }
    });
  }

  // ---------- Rock-solid "Yeni Oyun" ----------
  document.addEventListener('DOMContentLoaded', function(){
    const btn = document.getElementById('btnNewGame');
    if(!btn || btn.__kvRock) return;
    btn.__kvRock = true;
    // run BEFORE inline onclick (capture)
    btn.addEventListener('click', function(ev){
      // Do NOT block existing handler; first clear storage then let it run
      clearDoneAll();
      resetStats();
      resetGameStateOnly();
      // Let other handlers run. After they finish, refresh UI.
      setTimeout(refreshAll, 0);
    }, true);
  });

})();
</script>
<!-- === /KV PATCH v3 === -->
html>
